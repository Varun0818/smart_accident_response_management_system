{% extends 'core/base.html' %}

{% block extra_css %}
<style>
    /* --- ADDED: Map Style --- */
    #map {
        height: 250px;
        width: 100%;
        border-radius: 10px;
        margin-bottom: 20px;
        background: #f5f5fa;
        box-shadow: 0 2px 12px #1051e010;
    }

    .status-card {
        text-align: center;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    .status-reported {
        background-color: #f8d7da;
    }
    .status-alerted {
        background-color: #fff3cd;
    }
    .status-enroute {
        background-color: #d1e7dd;
    }
    .status-icon {
        font-size: 48px;
        margin-bottom: 15px;
    }
    .stats-container {
        display: flex;
        justify-content: space-around;
        margin-top: 20px;
    }
    .stat-item {
        text-align: center;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
        width: 45%;
    }
    .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #0d6efd;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Accident Response Status</h4>
            </div>
            <div class="card-body">
                <!-- --- ADDED: Map Container --- -->
                <h5 class="mb-3">Live Tracking</h5>
                <div id="map"></div>

                {% if report.status == 'reported' %}
                <div class="status-card status-reported">
                    <div class="status-icon">‚è≥</div>
                    <h3>Finding Nearby Emergency Services</h3>
                    <p>Please wait while we locate the nearest hospitals...</p>
                </div>
                {% elif report.status == 'alerted' %}
                <div class="status-card status-alerted">
                    <div class="status-icon">üö®</div>
                    <h3>Nearby Hospitals Have Been Alerted</h3>
                    <p>Waiting for a hospital to accept your case...</p>
                </div>
                {% elif report.status == 'enroute' %}
                <div class="status-card status-enroute">
                    <div class="status-icon">üöë</div>
                    <h3>Ambulance En Route</h3>
                    <p>{{ report.assigned_hospital }} is responding to your emergency</p>
                    
                    <div class="stats-container">
                        <div class="stat-item">
                            <div class="stat-label">Distance</div>
                            <div class="stat-value">{{ report.live_distance_km|default:"--" }} km</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">ETA</div>
                            <div class="stat-value">{{ report.eta_min|default:"--" }} min</div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <div class="mt-4">
                    <h5>Report Details</h5>
                    <table class="table">
                        <tr>
                            <th>Description:</th>
                            <td>{{ report.description }}</td>
                        </tr>
                        <tr>
                            <th>Severity:</th>
                            <td>
                                {% if report.severity == 'Minor' %}
                                <span class="badge bg-success">Minor</span>
                                {% elif report.severity == 'Moderate' %}
                                <span class="badge bg-warning">Moderate</span>
                                {% else %}
                                <span class="badge bg-danger">Severe</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Reported At:</th>
                            <td>{{ report.timestamp }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // --- ADDED: Map JavaScript ---
    let map, accidentMarker, reporterMarker;

    function initMap() {
        const accidentLocation = { lat: {{ report.latitude }}, lng: {{ report.longitude }} };
        
        map = new google.maps.Map(document.getElementById("map"), {
            center: accidentLocation, 
            zoom: 15
        });

        // 1. Add a marker for the accident location
        accidentMarker = new google.maps.Marker({
            position: accidentLocation,
            map: map,
            title: "Accident Location",
            icon: {
                url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png",
                scaledSize: new google.maps.Size(40, 40)
            }
        });

        // 2. Get and watch the reporter's live location
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(
                (position) => {
                    const reporterPos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                    };

                    // Create the marker if it doesn't exist
                    if (!reporterMarker) {
                        reporterMarker = new google.maps.Marker({
                            position: reporterPos,
                            map: map,
                            title: "Your Location",
                            icon: {
                                // Using a blue dot to differentiate
                                url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                                scaledSize: new google.maps.Size(40, 40)
                            }
                        });
                    } else {
                        // Just update the position if the marker already exists
                        reporterMarker.setPosition(reporterPos);
                    }
                },
                () => {
                    // Handle error (e.g., user denies location permission)
                    console.log("Error getting reporter's location.");
                }
            );
        }
    }

    // Load the map when the window is ready
    window.onload = initMap;
    // --- End of new map code ---


    // Refresh the page every 30 seconds to get status updates
    setTimeout(function() {
        location.reload();
    }, 30000);
</script>
{% endblock %}
