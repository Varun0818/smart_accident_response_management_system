{% extends 'core/base.html' %}

{% block extra_css %}
<style>
body {
    background: linear-gradient(120deg, #fff 60%, #bfcfff 100%) no-repeat;
    min-height: 100vh;
}

.report-panel {
    background: #fff;
    border-radius: 2.1rem;
    box-shadow: 0 0 0 2px #f5f5fc, 0 10px 50px 0 #cac2ff44, 0 0 80px 18px #d8dfff22;
    padding: 2.2rem 3.7rem 1.9rem 3.7rem;
    max-width: 810px;
    margin: 4.6rem auto 1.5rem auto;
    transition: box-shadow .18s, transform .13s;
    position: relative;
}

.report-panel:before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 2.1rem;
    box-shadow: 0 0 44px 14px #d3deff33;
    opacity: 0.32;
    z-index: 0;
    filter: blur(14px);
}

.card-header {
    border-radius: 2.1rem 2.1rem 0 0 !important;
    background: linear-gradient(90deg,#bcb5fd 2%,#bca2fa 55%,#c6a8f9 120%) !important;
    color: #fff !important;
    font-size: 1.4rem;
    font-weight: 800;
    letter-spacing: .2px;
    text-align: center;
    box-shadow: none;
    border: none !important;
    z-index: 1;
    position: relative;
}

#map {
    height: 160px;
    background: #f5f7fa;
    border-radius: 1.1rem;
    box-shadow: 0 2px 14px #b5baf71a;
    margin-bottom: 13px;
    z-index: 1;
    position: relative;
}

.form-label { font-weight: 600; color: #656281; margin-bottom: 4px;}
.form-control, textarea.form-control {
    border-radius: 1.7rem;
    border: none;
    font-size: 1.03rem;
    background: #f7f9fa;
    margin-bottom: .63rem;
    padding: .95rem 1.2rem;
    box-shadow: 0 2px 5px #e2e2fa06;
}
.form-control:focus, textarea.form-control:focus {
    background: #f4f7ff;
    box-shadow: 0 0 0 2px #c5bcf833;
}

.severity-row {
    display: flex;
    gap: 1.7rem;
    justify-content: center;
    margin-bottom: .7rem;
}
.severity-card {
    width: 120px;
    height: 120px;
    border-radius: 1.25rem !important;
    border: none;
    box-shadow: 0 0px 12px #ab9bfd12;
    background: #f5f7fd;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    transition: box-shadow .14s, background .13s;
    outline: none;
    padding: 0;
    position: relative;
}
.severity-card.selected,
.severity-card:focus,
.severity-card:hover {
    box-shadow: 0 3px 16px #6952ea27;
    background: #eceefd;
}
.severity-card b {
    font-size: 1.12rem;
    letter-spacing: .01em;
    margin-bottom: .33rem;
}
.severity-card label {
    font-weight: 600;
    margin-bottom: .23rem;
    cursor: pointer;
}
.severity-card p {
    font-size: .95rem;
    color: #8887ad;
    margin-bottom: 0;
}
.btn-danger, .btn-lg {
    background: linear-gradient(90deg, #b997fc 2%, #baa4ff 88%);
    color: #fff;
    border: none;
    border-radius: 2rem;
    padding: .94rem 0;
    font-size: 1.08rem;
    font-weight: 800;
    margin-top: 1.1rem;
    width: 100%;
    letter-spacing: .11em;
    box-shadow: 0 2px 7px #cfc9ff14;
    transition: background .16s, transform .11s;
}
.btn-danger:disabled {
    background-color: #d6d2f6 !important;
    color: #a1a7b9 !important;
    box-shadow: none !important;
    cursor: not-allowed;
    opacity: 0.65;
}
@media (max-width:1022px){
    .report-panel {max-width:97vw;}
    .severity-card { width:90px;height:90px;}
    .card-header{font-size:1.15rem;}
}
@media (max-width:700px){
    .report-panel {padding: 1.2rem .2rem;}
    .severity-row{gap: .7rem;}
}
</style>
{% endblock %}

{% block content %}
<div class="report-panel">
    <div class="card-header mb-3">
        <h4 class="mb-0">Report an Accident</h4>
    </div>
    <div class="card-body" style="z-index:1;position:relative;">
        <form method="post" enctype="multipart/form-data" id="accidentForm">
            {% csrf_token %}
            <div class="mb-2">
                <label class="form-label">Location</label>
                <div id="map"></div>
                <input type="hidden" id="latitude" name="latitude" value="0" required>
                <input type="hidden" id="longitude" name="longitude" value="0" required>
            </div>
            <div class="mb-2">
                <label for="description" class="form-label">Description of Accident</label>
                <textarea class="form-control" id="description" name="description" rows="2" required></textarea>
            </div>
            <div class="mb-2">
                <label class="form-label">Severity</label>
                <div class="severity-row">
                    <div class="severity-card" onclick="selectSeverity('Minor')" tabindex="0">
                        <input type="radio" name="severity" value="Minor" id="severity-minor" class="d-none">
                        <label for="severity-minor"><b>Minor</b></label>
                        <p>Minor injuries<br>no immediate danger</p>
                    </div>
                    <div class="severity-card" onclick="selectSeverity('Moderate')" tabindex="0">
                        <input type="radio" name="severity" value="Moderate" id="severity-moderate" class="d-none">
                        <label for="severity-moderate"><b>Moderate</b></label>
                        <p>Significant injuries<br>prompt attention needed</p>
                    </div>
                    <div class="severity-card" onclick="selectSeverity('Severe')" tabindex="0">
                        <input type="radio" name="severity" value="Severe" id="severity-severe" class="d-none">
                        <label for="severity-severe"><b>Severe</b></label>
                        <p>Life-threatening<br>immediate response</p>
                    </div>
                </div>
            </div>
            <div class="mb-2">
                <label for="image" class="form-label">Upload Photo (optional)</label>
                <input type="file" class="form-control" id="image" name="image" accept="image/*">
            </div>
            <button type="submit" class="btn btn-danger btn-lg w-100" id="submitBtn" disabled>Loading Map...</button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const submitBtn = document.getElementById('submitBtn');
const accForm = document.getElementById('accidentForm');
function setLocationAndEnableSubmit(lat, lng) {
    document.getElementById('latitude').value = lat;
    document.getElementById('longitude').value = lng;
    submitBtn.disabled = false;
    submitBtn.textContent = "Submit Report";
}
function initMap() {
    const defaultLoc = { lat: 17.385, lng: 78.486 };
    let map = new google.maps.Map(document.getElementById('map'), {
        center: defaultLoc, zoom: 15
    });
    let marker;
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            position => {
                const userLoc = { lat: position.coords.latitude, lng: position.coords.longitude };
                map.setCenter(userLoc);
                marker = new google.maps.Marker({
                    position: userLoc, map: map, draggable: true, title: "Accident Location"
                });
                setLocationAndEnableSubmit(userLoc.lat, userLoc.lng);
                google.maps.event.addListener(marker, 'dragend', function() {
                    const pos = marker.getPosition();
                    setLocationAndEnableSubmit(pos.lat(), pos.lng());
                });
            },
            () => {
                marker = new google.maps.Marker({
                    position: defaultLoc, map: map, draggable: true, title: "Accident Location"
                });
                setLocationAndEnableSubmit(defaultLoc.lat, defaultLoc.lng);
                google.maps.event.addListener(marker, 'dragend', function() {
                    const pos = marker.getPosition();
                    setLocationAndEnableSubmit(pos.lat(), pos.lng());
                });
            }
        );
    } else {
        marker = new google.maps.Marker({
            position: defaultLoc, map: map, draggable: true, title: "Accident Location"
        });
        setLocationAndEnableSubmit(defaultLoc.lat, defaultLoc.lng);
        google.maps.event.addListener(marker, 'dragend', function() {
            const pos = marker.getPosition();
            setLocationAndEnableSubmit(pos.lat(), pos.lng());
        });
    }
}
function selectSeverity(severity) {
    document.querySelectorAll('input[name="severity"]').forEach(i => i.checked = false);
    document.getElementById(`severity-${severity.toLowerCase()}`).checked = true;
    document.querySelectorAll('.severity-row .severity-card').forEach(card => card.classList.remove('border', 'shadow', 'selected'));
    document.querySelector(`input[value="${severity}"]`).closest('.severity-card').classList.add('border', 'shadow', 'selected');
}
accForm.onsubmit = function(e) {
    let lat = document.getElementById("latitude").value;
    let lon = document.getElementById("longitude").value;
    if (!lat || !lon || lat === "0" || lon === "0") {
        alert("Please select your accident location on the map.");
        e.preventDefault();
        return false;
    }
    let severityChecked = document.querySelector('input[name="severity"]:checked');
    if (!severityChecked) {
        alert("Please select the accident severity.");
        e.preventDefault();
        return false;
    }
};
</script>
{% if GOOGLE_MAPS_API_KEY %}
<script async src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initMap"></script>
{% else %}
<!-- Google Maps API key not configured; map will not load. Set GOOGLE_MAPS_API_KEY in env. -->
{% endif %}
{% endblock %}
