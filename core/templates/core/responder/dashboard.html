{% extends 'core/base.html' %}

{% block extra_css %}
<style>
.dashboard-title {
    text-align: left;
    font-size: 2rem;
    font-weight: 900;
    margin-bottom: .6rem;
    color: #1051e0;
    letter-spacing: .5px;
}
.user-info {
    font-size: 1.08rem;
    color: #3b4360;
    margin-bottom: 2rem;
}
#map {
    height: 330px;
    width: 100%;
    border-radius: 12px;
    margin-bottom: 22px;
    background: #fafbff;
    box-shadow: 0 2px 14px #1051e010;
}

.card {
    border-radius: 1.08rem;
    box-shadow: 0 4px 20px #badafa23, 0 2px 13px #6ae6dd30;
    margin-bottom: 2rem;
}

.card-header {
    border-radius: 1.08rem 1.08rem 0 0;
    font-weight: 700;
    font-size: 1.19rem;
    box-shadow: 0 2px 7px #1051e012;
}
.report-list {
    margin: 0;
    padding: 0;
}
.report-card {
    border-left: 6px solid #dc3545;
    margin-bottom: 19px;
    box-shadow: 0 2px 10px #dc354522, 0 1px 8px #1051e01a;
    border-radius: .87rem;
    transition: 0.16s box-shadow, 0.17s border;
    background: #fff7fa;
    padding: 0;
    overflow: hidden;
}
.report-card.minor {
    border-left-color: #28a745;
    background: #f5fbf7;
}
.report-card.moderate {
    border-left-color: #ffc107;
    background: #fffaed;
}
.report-card.severe {
    border-left-color: #dc3545;
    background: #fff4f5;
}
.report-card:hover {
    box-shadow: 0 8px 32px #10e0b530;
    transform: scale(1.03) translateY(-2px);
    border-left-width: 13px;
}
.card-title {
    font-weight: 700;
    color: #19234a;
    font-size: 1.15rem;
}
.badge {
    font-size: 1.12rem;
    font-weight: 700;
    padding: 5px 19px;
    border-radius: 13px;
    margin-left: 9px;
    letter-spacing: .02em;
}
.bg-success {background: #28a745;}
.bg-warning {background: #ffc107; color: #222;}
.bg-danger {background:#dc3545;}
.bg-info {background: #17a2b8; color: #fff;}
.bg-secondary {background:#868e96;}
.report-card .card-body {
    padding: 1.3rem 1rem 1rem 1rem;
}
.btn-sm {
    border-radius: 13px !important;
    font-weight: 700;
    letter-spacing: .01em;
    font-size: .98rem;
}
.status-label {font-weight: 600; color: #355;}
@media (max-width: 650px) {
    .dashboard-title {font-size: 1.1rem;}
    .card-header {font-size: 1rem;}
}
</style>
{% endblock %}

{% block content %}
<h2 class="dashboard-title">Responder Dashboard</h2>
<p class="user-info">Logged in as: <strong>{{ request.session.hospital_name }}</strong></p>

<div class="row">
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Active Incidents Map</h5>
            </div>
            <div class="card-body">
                <div id="map"></div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Active Reports</h5>
                <div>
                    <button class="btn btn-sm btn-light" onclick="filterReports('all')">All</button>
                    <button class="btn btn-sm btn-success" onclick="filterReports('Minor')">Minor</button>
                    <button class="btn btn-sm btn-warning" onclick="filterReports('Moderate')">Moderate</button>
                    <button class="btn btn-sm btn-danger" onclick="filterReports('Severe')">Severe</button>
                </div>
            </div>
            <div class="card-body">
                {% if reports %}
                <div class="report-list">
                    {% for report in reports %}
                    <div class="card report-card {{ report.severity|lower }}" data-severity="{{ report.severity }}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="card-title mb-0">{{ report.description }}</h5>
                                <span class="badge {% if report.severity == 'Minor' %}bg-success{% elif report.severity == 'Moderate' %}bg-warning{% else %}bg-danger{% endif %}">
                                    {{ report.severity }}
                                </span>
                            </div>
                            <p class="card-text mb-1">
                                <small class="text-muted">Reported by {{ report.reporter_name }} at {{ report.timestamp }}</small>
                            </p>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="status-label">Status:</span> 
                                    {% if report.status == 'reported' %}
                                    <span class="badge bg-secondary">Reported</span>
                                    {% elif report.status == 'alerted' %}
                                    <span class="badge bg-warning">Alerted</span>
                                    {% elif report.status == 'enroute' %}
                                    <span class="badge bg-info">En Route</span>
                                    {% else %}
                                    <span class="badge bg-success">Resolved</span>
                                    {% endif %}
                                </div>
                                <div>
                                    {% if report.status == 'alerted' %}
                                    <a href="{% url 'case_detail' report.id %}" class="btn btn-primary btn-sm">View Details</a>
                                    {% elif report.status == 'enroute' and report.assigned_hospital == request.session.hospital_name %}
                                    <a href="{% url 'case_detail' report.id %}" class="btn btn-info btn-sm">Track Case</a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p>No active reports at this time.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let map, markers = [];
// --- ADDED: New variable for the responder's own marker ---
let responderMarker = null;

function initMap() {
    const defaultLocation = { lat: 17.385, lng: 78.486 };
    map = new google.maps.Map(document.getElementById("map"), {
        center: defaultLocation, zoom: 12
    });

    // --- Add markers for all accident reports (existing code) ---
    {% for report in reports %}
    addMarker(
        { lat: {{ report.latitude }}, lng: {{ report.longitude }} },
        "{{ report.description }}",
        "{{ report.severity }}",
        "{{ report.status }}",
        {{ report.id }}
    );
    {% endfor %}

    if (markers.length > 0) {
        const bounds = new google.maps.LatLngBounds();
        markers.forEach(marker => bounds.extend(marker.getPosition()));
        map.fitBounds(bounds);
    }

    // --- ADDED: Get and watch the responder's live location ---
    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
            (position) => {
                const responderPos = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                };

                // Create the marker if it doesn't exist
                if (!responderMarker) {
                    responderMarker = new google.maps.Marker({
                        position: responderPos,
                        map: map,
                        title: "Your Location",
                        icon: {
                            // Using a blue dot to differentiate
                            url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                            scaledSize: new google.maps.Size(40, 40)
                        }
                    });
                } else {
                    // Just update the position if the marker already exists
                    responderMarker.setPosition(responderPos);
                }
            },
            () => {
                // Handle error (e.g., user denies location permission)
                console.log("Error getting responder's location.");
            }
        );
    }
    // --- End of new code ---
}

function addMarker(position, description, severity, status, reportId) {
    let icon = {
        url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png",
        scaledSize: new google.maps.Size(40, 40)
    };
    if (severity === "Minor") {
        icon.url = "http://maps.google.com/mapfiles/ms/icons/green-dot.png";
    } else if (severity === "Moderate") {
        icon.url = "http://maps.google.com/mapfiles/ms/icons/yellow-dot.png";
    }
    const marker = new google.maps.Marker({
        position: position, map: map, icon: icon, title: description
    });
    const contentString = `
        <div>
            <h5>${description}</h5>
            <p><strong>Severity:</strong> ${severity}</p>
            <p><strong>Status:</strong> ${status}</p>
            <a href="/responder/case/${reportId}/" class="btn btn-primary btn-sm">View Details</a>
        </div>
    `;
    const infowindow = new google.maps.InfoWindow({ content: contentString });
    marker.addListener("click", () => { infowindow.open(map, marker); });
    markers.push(marker);
}

function filterReports(severity) {
    const reportCards = document.querySelectorAll('.report-card');
    reportCards.forEach(card => {
        if (severity === 'all' || card.dataset.severity === severity) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

window.onload = initMap;

// We keep the 30-second refresh to get new *reports*
setTimeout(function() { location.reload(); }, 30000);
</script>
{% endblock %}
